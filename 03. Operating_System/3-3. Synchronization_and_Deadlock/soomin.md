# 03-3. 동기화와 교착 상태
- 공유 자원: 프로세스 혹은 스레드가 공유하는 자원
  - 메모리, 파일, 전역 변수, 입출력 장치 
- 임계 구역: 공유 자원에 접근하는 코드중 동시에 실행했을 때 문제가 발생할 수 있는 코드
- 레이스 컨디션 : 동시에 임계구역의 코드를 실행하여 문제가 발생하는 상황 
- 레이스 컨디션을 방지하면서 임계 구역을 관리하기 위해서는 동기화가 필요함

- **동기화 조건**
  1. 실행 순서 제어: 프로세스 및 스레드를 올바른 순서로 실행하기
  
  2. 상호 배제: 동시에 접근해서는 안 되는 자원에 하나의 프로세스 및 스레드만 접근하기 
<br>

## ✅동기화 기법

### ▶️뮤텍스 락

- mutex lock: 상호 배제를 보장하는 동기화 도구 
- MUTual EXclusion = 상호배제 
- 하나의 공유 자원을 고려
- 원리
  - 임계구역에 접근하려면 반드시 락을 획득(acquire)
  - 임계구역에서 작업이 끝나면 락을 해제(release)
  - 프로세스 및 스레드가 공유하는 변수(lock)와 2개의 함수(acquire, release)로 구현됨 
  - lock을 획득하지 못하면 임계구역 접근 불가 
  
### ▶️세마포
- semaphore : 공유자원이 여러 개 있는 상황에서도 동기화 가능
- 뮤텍스락보다 조금 더 일반화된 방식의 동기화 도구 
- 원리
  - 변수S : 사용 가능한 공유 자원의 개수
  - wait() : 임계구역 진입 전 호출하는 함수
  - signal() : 임계 구역 진입 후 호출하는 함수 
- 사용 가능한 공유 자원 = 임계구역에 진입할 수 있는 프로세스의 개수 
- 종류
  - 카운팅 세마포: 일반적인 세마포 
  - 이진 세마포: S가 0과 1만 → 뮤텍스 락과 유사 
  
### ▶️조건 변수와 모니터 
- condition variable: 실행 순서 제어를 위한 동기화 도구 
- 조건 변수에 함수 호출 가능 
  - 아직 특정 프로세스가 실행될 조건이 되지 않았을 때는 wait()을 통해 실행을 중단
  - 특정 프로세스가 실행될 조건이 충족되었을 때는 signal()을 통해 실행을 재개 
- monitor: 공유 자원과 그 공유 자원을 다루는 함수로 구성된 동기화 도구 
  - 동기화 2가지(상호배제, 실행 순서 제어) 가능 
- 원리
  - 공유 자원에 접근하기 위해 반드시 정해진 공유 자원 연산을 통해 모니터 내로 진입
  - 모니터 안에 진입하여 실행되는 프로세스 및 스레드는 항상 하나 
  - 이미 모니터 내에 실행중이면 큐에서 대기 
- 조건 변수 + 모니터 ⇒ 실행 순서 제어를 위한 동기화 구현 
- `synchronized`가 모니터를 사용하는 대표적인 예시 
  - 하나의 프로세스 및 스레드만 실행 가능 
  
### ▶️스레드 안전 
- thread safety: 멀티스레드 환경에서 어떤 변수나 함수, 객체에 동시 접근해도 실행에 문제가 없는 상태 
- 레이스 컨디션 발생 → 스레드 안전하지 않은 상황 
- 스레드 안전 → 여러 스레드에 의해 호출되어도 레이스 컨디션 발생x
- 예시 - 자바
  - `Vector.add` - `synchronized` → 스레드 안전 
  - `ArrayList.add` - `synchronized`X → 스레드 안전X
  
<br>

## ✅교착 상태 
- deadlock : 일어나지 않을 사건을 기다리며 프로세스의 진행이 멈춰 버리는 현상 

### ▶️발생 조건
- 4개의 조건이 모두 만족할 때 교착 상태가 발생할 가능성이 생긴다.

1.  **상호 배제**
한 프로세스가 사용하는 자원을 다른 프로세스가 사용할 수 없는 상황

2. **점유와 대기**
한 프로세스가 어떤 자원을 할당받은 상태에서 다른 자원 할당받기를 기다리는 상황 

3. **비선점**
해당 자원을 이용하는 프로세스의 작업이 끝나야만 자원 사용 가능. 다른 프로세스의 자원을 강제로 뺏지 못함

4. **원형 대기**
각각의 프로세스가 서로 점유한 자원을 할당받기 위해 원의 형태로 대기할 경우 

### ▶️해결 방법

- 교착 상태 **예방**
  - 4가지 조건 중 하나를 충족하지 못하게 하는 방법
  - OS가 발생 조건에 부합하지 않도록 자원을 분배

- 교착 상태 **회피** : 
  - 교착 상태는 한정된 자원의 무분별한 할당때문으로 간주 
  - 교착 상태가 발생하지 않도록 조금씩 자원을 할당 

- 교착 상태 **검출 후 회복**
  - 교착 상태의 발생을 인정하고 처리하는 사후 조치
  - 요구할 때마다 자원을 할당하고 주기적으로 교착 상태 발생 여부 검사 
  - 교착 상태가 해결될 때까지 다른 프로세스로부터 강제로 자원을 빼앗아 한 프로세스에 몰아서 할당하는 자원 선점을 통해 회복시키기
  - 프로세스를 강제 종료함으로써 회복시키기 
<br>

> 
📍스레드 안전하지 않은 메서드를 동기화하지 않으면 어떤 문제가 생길 수 있나요?
여러 스레드가 동시에 실행될 경우 레이스 컨디션이 발생하여 데이터의 일관성이 깨질 수 있습니다. 따라서 추가적인 동기화 도구를 적용하거나, 스레드 안전한 메서드를 사용해야합니다. 
vector의 add()는 스레드 안전하지만, arraylist의 add()는 스레드 안전하지 않다. 
>
📍교착 상태가 무엇인지, 왜 발생하는지
교착 상태는 2개 이상의 프로세스가 서로 상대방의 자원을 기다리며 무한정 대기한느 상황을 말합니다. 이는 4가지 조건이 충족될 때 발생할 수 있습니다. 
첫째, 자원이 상호 배제되어 한 번에 하나의 프로세스만 사용할 수 있은 경우. 
둘째, 이미 자원을 점유한 프로세스가 다른 자원을 기다리는 경우. 
셋째, 자원이 비선점되어 다른 프로세스가 강제로 자원을 빼앗지 못하는 경우. 
넷째, 프로세스들이 원형으로 자원을 대기하는 경우. 
이러한 조건들이 동시에 충족될 때 교착 상태가 발생할 수 있습니다.
