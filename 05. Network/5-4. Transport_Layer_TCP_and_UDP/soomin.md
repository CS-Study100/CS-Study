# 5-4. 전송 계층 - TCP와 UDP
## ✅TCP와 UDP의 목적과 특징
### ▶️포트를 통한 프로세스 식별
- 패킷의 최종 송수신 대상은 호스트가 실행하는 프로세스
- NW 상에서 호스트가 실행하는 프로세스는 어떻게 식별? 포트 번호를 통해
- IP 주소와 포트 번호의 조합을 통해 특정 호스트가 실행하는 특정 프로세스를 식별
    - `IP 주소:포트 번호`
      - IP 주소 - 호스트 식별
      - 포트 번호 - 애플리케이션 프로세스 식별 
- TCP와 UDP는 모두 포트를 통해 프로세스 식별
  - 송수신지 포트 번호 포함
- 16비트로 표현 - 0번 ~ 65536번
  - 3가지 종류
    - 잘 알려진 포트: 0~1023
    - 등록된 포트: 1024~49151
    - 동적 포트 - 사설 포트/임시 포트
      - 웹 브라우저 프로그램에는 동적 포트 내 임의의 포트 번호가 자동을 할당됨

#### 🔷NAT와 NAPT
- 공인 IP 주소와 사설 IP 주소 간 변환에 사용되는 기술

### ▶️(비)신뢰성과 (비)연결형 보장
- TCP
  - 신뢰 → 상태 관리, 흐름 제어, 오류 제어, 혼잡 제어 
  - 연결형 → 연결 수립, 종료 과정
  - 패킷의 유실 없는 송수신
- UDP - 비신뢰 & 비연결형 
  - 빠른 송수신 
  

- UDP 헤더
  - 송신지 포트
  - 수신지 포트
  - 길이
  - 체크섬 
- TCP 헤더
  - UDP 헤더의 모든 필드 
  - 순서 번호
  - 확인 응답 번호 - 신뢰성 보장 
  - 제어 비트(플래그 비트)
    - ACK - 승인, SYN - 연결 수립, FIN - 연결 종료
    
## ✅TCP의 연결부터 종료까지
- 송수신 이전에 연결 수립 
- 송수신 이후에 연결 종료 

### ▶️TCP의 연결 수립 
- 쓰리 웨이 핸드셰이크
1️⃣[A → B] SYN 
2️⃣[B → A] SYN + ACK 
3️⃣[A → B] ACK 


- 액티브 오픈 - 처음 연결을 시작하는 과정 → 클라이언트가
- 패시브 오픈 - 연결 요청을 수신한 뒤 그에 대한 연결을 수립하는 과정 → 서버가

### ▶️TCP의 오류•흐름•혼잡 제어
#### 1️⃣재전송을 통한 오류 제어
- 송수신 과정에 잘못 전송된 세그먼트가 있을 경우
- 언제 인지?
  1. 중복된 ACK 도착
  2. 타임아웃 발생 - 송신 호스트의 재전송 타이머가 끝나면 


🔷파이프라이닝 전송
- 기본적인 송수신 
  - 순서 번호 담은 세그먼트 보내기 → 확인 응답 담긴 세그먼트 받기 → 다음.. 반복
  - 단점 - 한 번에 여러 세그먼트를 보낼 수 없고 하나의 세그먼트만 주고 받아야함
- 오늘날은 파이프라이닝 전송
  - 한 번에 여러 세그먼트 보내고, 각 세그먼트에 대한 확인 응답 받기 


#### 2️⃣흐름 제어 - 주체 : 수신 호스트
- 송신 호스트가 수신 호스트의 처리 속도를 고려하여 송수신 속도 균일하게 맞추기 
- 수신 호스트의 전송량은 TCP 수신 버퍼에 의해 결정됨, 커널에 정의돼 있음
- 윈도우 필드에 수신 호스트가 처리할 수 있는 수신 윈도우 크기가 명시

#### 3️⃣혼잡 제어 - 주체 : 송신 호스트 
- 패킷 처리 속도 느려지거나 유시될 수 있는 상황
- 송신 호스트가 얼마나 NW가 혼잡한지 판단한 정도에 따라 세그먼트의 전송량 조절 
- 어떻게 판단?
  - 세그먼트의 전송 오류를 판단하는 것과 같음 
- 혼잡 윈도우 - 혼잡 없이 전송할 수 있을 정도의 양
  - 크다 - 한 번에 전송할 수 있는 세그먼트의 수가 많다
- 혼잡 윈도우 값을 넘지 않은 선에서 전송 
- 혼잡 제어 알고리즘 - 혼잡 윈도우의 크기를 연산하는 방법
  - AIMD - 합으로 증가, 곱으로 감소
    - 혼잡이 감지되지 않으면 혼잡 윈도우를 RTT마다 1씩 선형적으로 증가
    - RTT - 패킷을 보내고 그에 대한 응답이 수신되기까지의 시간 

### ▶️TCP의 종료
- 종료 단계
1️⃣[A → B] FIN 
2️⃣[B → A] ACK 
3️⃣[B → A] FIN
4️⃣[A → B] ACK

- 액티브 클로즈 - 먼저 연결을 종료하려는 호스트에 의해
- 패시브 클로즈 - 연결 종료 요청을 받아들이는 호스트 

## ✅TCP의 상태 관리
- TCP는 상태를 유지하고 관리하는 프로토콜 - 스테이트풀 프로토콜
- 상태 : 현재 어떤 통신 과정에 있는지를 나타내는 정보 
- 상태 정보를 토대로
  - 송수신 현황 판단
  - 디버깅의 힌트 


1️⃣연결이 수립되지 않았을 때 주로 활용되는 상태
  - CLOSED - 아무런 연결X
  - LISTEN - 연결 대기

2️⃣연결 수립 과정에서 주로 활용되는 상태
  - SYN-SENT
  - SYN-RECEIVED
  - ESTABLISHED

3️⃣연결 종료 과정에서 주료 활용되는 상태 
  - FIN-WAIT-1
  - CLOSE-WAIT
  - FIN-WAIT-2
  - LAST-ACK
  - TIME-WAIT - 일정 시간을 기다린 뒤 CLOSED 상태


 🔷CLOSING 상태
 - 서로가 FIN을 보내고 받은 뒤, 자신의 FIND에 대한 ACK를 받지 못했을 때 
