# 5-4. 전송 계층 - TCP와 UDP

## ✅ TCP와 UDP의 목적과 특징

### 포트를 통한 프로세스 식별
- 패킷의 최종 송수신 대상은 **호스트가 실행하는 프로세스**.
- 네트워크 상에서 **포트 번호**를 통해 호스트가 실행하는 프로세스를 식별:
  - `IP 주소:포트 번호`
    - **IP 주소**: 호스트 식별.
    - **포트 번호**: 애플리케이션 프로세스 식별.
- TCP와 UDP는 모두 **송수신지 포트 번호**를 포함하여 프로세스를 식별.
- 포트 번호는 **16비트**로 표현 (0~65535):
  - **잘 알려진 포트**: 0~1023
  - **등록된 포트**: 1024~49151
  - **동적 포트 (사설/임시 포트)**: 49152~65535

---

### **NAT** 
공인 IP 주소와 사설 IP 주소 간 변환 기술.
### **NAPT**
여러 사설 IP 주소를 하나의 공인 IP 주소로 변환.

---

### ✅ (비)신뢰성과 (비)연결형 보장
- **TCP**:
  - **신뢰성 보장**: 상태 관리, 흐름 제어, 오류 제어, 혼잡 제어.
  - **연결형**: 송수신 이전에 연결 수립, 송수신 이후에 연결 종료.
  - **패킷 유실 없는 송수신** 제공.
- **UDP**:
  - **비신뢰성**, **비연결형**.
  - 빠른 송수신에 초점.

### ✅ UDP 헤더
- 송신지 포트, 수신지 포트, 길이, 체크섬.

### ✅ TCP 헤더
- UDP 헤더 필드 + 추가 필드:
  - 순서 번호
  - 확인 응답 번호 (신뢰성 보장)
  - 제어 비트 (플래그 비트):  
    - **ACK**: 승인.  
    - **SYN**: 연결 수립.  
    - **FIN**: 연결 종료.

---

## ✅ TCP의 연결부터 종료까지

### TCP의 연결 수립
- **쓰리 웨이 핸드셰이크 (Three-Way Handshake)**:
  1️⃣ [A → B] **SYN** (연결 요청)  
  2️⃣ [B → A] **SYN + ACK** (연결 요청 승인)  
  3️⃣ [A → B] **ACK** (연결 승인 확인)

- **액티브 오픈**: 클라이언트가 연결 시작.
- **패시브 오픈**: 서버가 연결 요청 수신 후 연결 수립.

---

##  TCP의 오류, 흐름, 혼잡 제어

### 1️⃣ 재전송을 통한 오류 제어
- 송수신 중 잘못 전송된 세그먼트를 재전송:
  - **중복된 ACK 도착**.
  - **타임아웃 발생** (재전송 타이머 만료).

#### 파이프라이닝 전송
- 기본 방식: 세그먼트 1개 송신 → 확인 응답 수신 → 다음 송신.  
- **파이프라이닝 전송**: 여러 세그먼트를 한 번에 송신 → 각 세그먼트에 대한 확인 응답 수신.

### 2️⃣ 흐름 제어
- 주체: **수신 호스트**.
- 송신 호스트가 **수신 호스트의 처리 속도**를 고려해 송수신 속도 조절.
- **TCP 수신 버퍼**에 의해 처리 가능 용량 결정.
- **수신 윈도우 크기**는 TCP 헤더의 윈도우 필드에 명시.

### 3️⃣ 혼잡 제어
- 주체: **송신 호스트**.
- 네트워크 혼잡 상황을 판단해 **세그먼트 전송량** 조절:
  - 판단 기준: 전송 오류 발생 여부.
- **혼잡 윈도우 (Congestion Window)**:
  - 혼잡 없이 전송 가능한 데이터 양.
  - 값이 클수록 한 번에 전송할 수 있는 세그먼트 양이 많음.
- **혼잡 제어 알고리즘**:
  - **AIMD (Additive Increase, Multiplicative Decrease)**:
    - 혼잡이 없으면 RTT마다 혼잡 윈도우를 1씩 선형 증가.
    - 혼잡이 발생하면 혼잡 윈도우를 감소.

---

## ✅ TCP의 종료
- **종료 단계 (Four-Way Handshake)**:
  1️⃣ [A → B] **FIN** (연결 종료 요청).  
  2️⃣ [B → A] **ACK** (연결 종료 승인).  
  3️⃣ [B → A] **FIN** (연결 종료 요청).  
  4️⃣ [A → B] **ACK** (연결 종료 승인).

- **액티브 클로즈**: 먼저 연결 종료 요청.
- **패시브 클로즈**: 연결 종료 요청 수락.

---

## ✅ TCP의 상태 관리
- **스테이트풀 프로토콜**: 상태 정보를 유지하고 관리.
- **상태 정보**로 송수신 현황 판단 및 디버깅에 활용.

### 주요 상태
1️⃣ **연결 수립 전**:  
  - **CLOSED**: 아무 연결 없음.  
  - **LISTEN**: 연결 대기.  

2️⃣ **연결 수립 중**:  
  - **SYN-SENT**: 연결 요청 송신.  
  - **SYN-RECEIVED**: 연결 요청 수신 및 승인 대기.  
  - **ESTABLISHED**: 연결 완료.  

3️⃣ **연결 종료 중**:  
  - **FIN-WAIT-1**: FIN 송신 대기.  
  - **CLOSE-WAIT**: FIN 수신 대기.  
  - **FIN-WAIT-2**: FIN 승인 후 종료 대기.  
  - **LAST-ACK**: FIN 송신 후 ACK 대기.  
  - **TIME-WAIT**: 일정 시간 대기 후 CLOSED.

